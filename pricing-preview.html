<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>OTA Admin • Pricing Preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

<div id="appPage">

    <div class="topbar">
        <div class="topbarInner">

            <div class="brand">
                <div class="mark">
                    <svg width="20" height="20" fill="none" stroke="white" stroke-width="2">
                        <path d="M12 22s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-size:12px;font-weight:1000;">OTA Admin</div>
                    <div style="font-size:11px;color:#7c879a;font-weight:900;">Pricing Preview</div>
                </div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn active">Pricing Preview</button>
                <button class="btn" onclick="location.href='access-control.html'">Access Control</button>
                <button class="btn" onclick="location.href='login-logs.html'">Login Logs</button>
                <button class="btn" id="btnLogout">Logout</button>
            </div>

        </div>
    </div>

    <div class="shell">

        <div class="hero"></div>

        <section class="section">
            <div class="sectionHeader">
                <div class="sectionTitle">
          <span class="titleIcon" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 2h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
                    Request Filters
                </div>

                <div id="submitState" class="runState" style="display:none;">
                    <span class="spinner"></span> Running
                </div>
            </div>

            <div class="sectionBody">
                <div class="grid">
                    <div class="field col4">
                        <div class="label">Partner</div>
                        <select id="partnerId"></select>
                        <div class="hint" id="partnerHint"></div>
                    </div>

                    <div class="field col4">
                        <div class="label">Group</div>
                        <select id="groupId"></select>
                        <div class="hint" id="groupHint"></div>
                    </div>

                    <div class="field col2">
                        <div class="label">Journey Type</div>
                        <select id="journeyType"></select>
                        <div class="hint" id="journeyHint"></div>
                    </div>

                    <div class="field col2">
                        <div class="label">Airline</div>
                        <input id="airline" placeholder="BG" value="BG" maxlength="2"/>
                    </div>
                </div>

                <div class="segment">
                    <div class="segmentHead">
                        <div class="segmentTitle">
              <span class="badgeIcon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M10 14l11-11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M21 7v-4h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M14 10L3 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
                            Segment (single)
                        </div>
                    </div>

                    <div class="segmentBody">
                        <div class="grid">
                            <div class="field col4">
                                <div class="label">Origin</div>
                                <input id="segOrigin" placeholder="DAC" value="DAC" maxlength="3"/>
                            </div>

                            <div class="field col4">
                                <div class="label">Destination</div>
                                <input id="segDestination" placeholder="CXB" value="CXB" maxlength="3"/>
                            </div>

                            <div class="field col4">
                                <div class="label">Departure Date</div>
                                <input id="segDate" type="date" value="2025-12-30"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn" id="btnReset" type="button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M21 12a9 9 0 1 1-3-6.7" stroke="currentColor" stroke-width="2"
                                  stroke-linecap="round"/>
                            <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Reset
                    </button>

                    <button class="btn primary" id="btnSubmit" type="button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M5 12h12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            <path d="M13 6l6 6-6 6" stroke="white" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                        Run Preview
                    </button>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="sectionHeader">
                <div class="sectionTitle">
          <span class="titleIcon" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16v14H4V6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M4 10h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 20V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
                    Preview Output
                </div>
                <span class="pill" id="resultPill">No data</span>
            </div>

            <div class="sectionBody">
                <div id="empty" class="empty">No preview loaded.</div>

                <div id="cardsRow" class="cardsRow" style="display:none;">
                    <div class="card" data-accent="supplier">
                        <div class="cardStripe"></div>
                        <div class="cardHead">
                            <div class="cardTitle">
                <span class="iconBadge" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 10V20h16V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M2 10l10-6 10 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
                                Supplier
                            </div>
                            <span class="pill ok" id="supplierPill"></span>
                        </div>
                        <div class="cardBody">
                            <div class="kv">
                                <div class="row">
                                    <div class="k">Supplier Name</div>
                                    <div class="v" id="supplierName"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Supplier Code</div>
                                    <div class="v" id="supplierCode"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Currency</div>
                                    <div class="v" id="supplierCurrency"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" data-accent="markup">
                        <div class="cardStripe"></div>
                        <div class="cardHead">
                            <div class="cardTitle">
                <span class="iconBadge" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 7h16v10H4V7z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
                                Markup
                            </div>
                            <span class="pill" id="markupPill"></span>
                        </div>
                        <div class="cardBody">
                            <div class="kv">
                                <div class="row">
                                    <div class="k">Enabled</div>
                                    <div class="v" id="markupEnabled"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Applied On</div>
                                    <div class="v" id="markupAppliedOn"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Type</div>
                                    <div class="v" id="markupType"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Value</div>
                                    <div class="v" id="markupValue"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" data-accent="discount">
                        <div class="cardStripe"></div>
                        <div class="cardHead">
                            <div class="cardTitle">
                <span class="iconBadge" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 12l8-8 8 8-8 8-8-8z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M9 15l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
                                Discount
                            </div>
                            <span class="pill" id="discountPill"></span>
                        </div>
                        <div class="cardBody">
                            <div class="kv">
                                <div class="row">
                                    <div class="k">Enabled</div>
                                    <div class="v" id="discountEnabled"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Applied On</div>
                                    <div class="v" id="discountAppliedOn"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Type</div>
                                    <div class="v" id="discountType"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Value</div>
                                    <div class="v" id="discountValue"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" data-accent="commission">
                        <div class="cardStripe"></div>
                        <div class="cardHead">
                            <div class="cardTitle">
                <span class="iconBadge" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 1v22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M17 6H9.5a3.5 3.5 0 0 0 0 7H14a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round"/>
                  </svg>
                </span>
                                Commission <span class="metaInline" id="commissionSourceInline"></span>
                            </div>
                            <span class="pill" id="commissionPill"></span>
                        </div>
                        <div class="cardBody">
                            <div class="kv">
                                <div class="row">
                                    <div class="k">Enabled</div>
                                    <div class="v" id="commissionEnabled"></div>
                                </div>
                                <div class="row" id="airlineCodeRow">
                                    <div class="k">Airline Code</div>
                                    <div class="v" id="commissionAirlineCode"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Applied On</div>
                                    <div class="v" id="commissionAppliedOn"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Type</div>
                                    <div class="v" id="commissionType"></div>
                                </div>
                                <div class="row">
                                    <div class="k">Value</div>
                                    <div class="v" id="commissionValue"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </div>

    <div class="toastHost" id="toastHost" aria-live="polite" aria-atomic="true"></div>

</div>

<script>
    if (!localStorage.getItem("accessToken")) {
        location.href = "index.html";
    }

    function getToken() {
        return "Bearer " + (localStorage.getItem("accessToken") || "");
    }

    btnLogout.onclick = () => {
        localStorage.removeItem("accessToken");
        location.href = "index.html";
    };

    /* ================= PRICING API ================= */

    const PRICING_PREVIEW_URL = "https://akijair.ibos.io/configuration-management/v1/supplier-info/pricing/preview";
    const PARTNER_LOOKUP_URL = "https://akijair.ibos.io/user-management/v1/lookups/active-approved-b2b-partners";
    const GROUP_LOOKUP_URL = "https://akijair.ibos.io/configuration-management/v1/lookups/fmg-groups";
    const JOURNEY_LOOKUP_URL = "https://akijair.ibos.io/configuration-management/v1/lookups/journey-types";

    const allowedJourneyCodes = new Set(["1", "2", "3"]);

    const appliedOnMap = {0: "0", 1: "Total", 2: "Base"};
    const typeMap = {0: "0", 1: "Percentage", 2: "Flat"};

    const $ = (id) => document.getElementById(id);

    function setHealth(state, text) {
        const dot = $("healthDot");
        dot.className = "dot" + (state ? (" " + state) : "");
        $("healthText").textContent = text || "Ready";
    }

    function setSubmitting(on) {
        $("submitState").style.display = on ? "" : "none";
        $("btnSubmit").disabled = on;
        $("btnReset").disabled = on;
    }

    function setHint(id, msg) {
        const el = $(id);
        if (!msg) {
            el.textContent = "";
            el.classList.remove("show");
            return;
        }
        el.textContent = msg;
        el.classList.add("show");
    }

    function setPill(id, variant, text) {
        const el = $(id);
        el.className = "pill" + (variant ? (" " + variant) : "");
        el.textContent = text || "";
    }

    function showResults(show) {
        $("cardsRow").style.display = show ? "" : "none";
        $("empty").style.display = show ? "none" : "";
    }

    function toast(kind, title, message, timeout = 3200) {
        const host = $("toastHost");
        const t = document.createElement("div");
        t.className = "toast";

        const icon = document.createElement("div");
        icon.className = "toastIcon " + (kind || "");
        icon.innerHTML = (kind === "ok")
            ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="#166534" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
            : (kind === "bad")
                ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18" stroke="#7f1d1d" stroke-width="2" stroke-linecap="round"/><path d="M6 6l12 12" stroke="#7f1d1d" stroke-width="2" stroke-linecap="round"/></svg>`
                : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 9v4" stroke="#7c2d12" stroke-width="2" stroke-linecap="round"/><path d="M12 17h.01" stroke="#7c2d12" stroke-width="2" stroke-linecap="round"/><path d="M10.3 4.3l-7.6 13.2A2 2 0 0 0 4.4 20h15.2a2 2 0 0 0 1.7-2.5L13.7 4.3a2 2 0 0 0-3.4 0z" stroke="#7c2d12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        const text = document.createElement("div");
        text.className = "toastText";
        text.innerHTML = `<p class="toastTitle">${escapeHtml(title || "")}</p><p class="toastMsg">${escapeHtml(message || "")}</p>`;

        const close = document.createElement("button");
        close.className = "toastClose";
        close.type = "button";
        close.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18" stroke="#5b677a" stroke-width="2" stroke-linecap="round"/><path d="M6 6l12 12" stroke="#5b677a" stroke-width="2" stroke-linecap="round"/></svg>`;
        close.onclick = () => t.remove();

        t.appendChild(icon);
        t.appendChild(text);
        t.appendChild(close);
        host.appendChild(t);

        if (timeout > 0) setTimeout(() => {
            try {
                t.remove();
            } catch {
            }
        }, timeout);
    }

    function escapeHtml(s) {
        return String(s ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function omitEmpty(obj) {
        const out = {};
        for (const [k, v] of Object.entries(obj)) {
            if (v === undefined || v === null) continue;
            if (typeof v === "string" && v.trim() === "") continue;

            if (Array.isArray(v)) {
                const cleaned = v
                    .map(x => (x && typeof x === "object" && !Array.isArray(x)) ? omitEmpty(x) : x)
                    .filter(x => {
                        if (x === undefined || x === null) return false;
                        if (typeof x === "string" && x.trim() === "") return false;
                        if (typeof x === "object" && !Array.isArray(x) && Object.keys(x).length === 0) return false;
                        return true;
                    });
                if (cleaned.length === 0) continue;
                out[k] = cleaned;
                continue;
            }

            if (typeof v === "object") {
                const cleaned = omitEmpty(v);
                if (Object.keys(cleaned).length === 0) continue;
                out[k] = cleaned;
                continue;
            }

            out[k] = v;
        }
        return out;
    }

    function buildPayload() {
        const origin = $("segOrigin").value.trim().toUpperCase();
        const destination = $("segDestination").value.trim().toUpperCase();
        const departureDate = $("segDate").value;

        const segment = omitEmpty({origin, destination, departureDate});

        const base = {
            partnerId: $("partnerId").value.trim(),
            groupId: $("groupId").value.trim(),
            journeyType: Number($("journeyType").value),
            segments: Object.keys(segment).length ? [segment] : [],
            airline: $("airline").value.trim().toUpperCase()
        };
        return omitEmpty(base);
    }

    async function safeJsonFetch(url) {
        const res = await fetch(url, {
            method: "GET",
            headers: {
                "accept": "*/*",
                "Authorization": getToken()
            }
        });
        const text = await res.text();
        try {
            return JSON.parse(text);
        } catch {
            return null;
        }
    }

    function fillSelect(selectEl, placeholderText, items) {
        selectEl.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";
        ph.textContent = placeholderText;
        ph.selected = true;
        selectEl.appendChild(ph);

        for (const it of items) {
            const opt = document.createElement("option");
            opt.value = it.id;
            opt.textContent = it.name;
            selectEl.appendChild(opt);
        }
    }

    async function loadPartners() {
        const select = $("partnerId");
        fillSelect(select, "Loading partners…", []);
        setHint("partnerHint", "");

        try {
            const json = await safeJsonFetch(PARTNER_LOOKUP_URL);
            if (!json?.isSuccess || !Array.isArray(json?.data)) {
                fillSelect(select, "Select a partner (optional)", []);
                setHint("partnerHint", json?.message || "Unable to load partners.");
                return;
            }

            const items = json.data
                .map(p => ({id: String(p.partnerId || "").toUpperCase(), name: p.companyName || ""}))
                .filter(x => x.id && x.name)
                .sort((a, b) => a.name.localeCompare(b.name));

            fillSelect(select, "Select a partner (optional)", items);
        } catch {
            fillSelect(select, "Select a partner (optional)", []);
            setHint("partnerHint", "Unable to load partners.");
        }
    }

    async function loadGroups() {
        const select = $("groupId");
        fillSelect(select, "Loading groups…", []);
        setHint("groupHint", "");

        try {
            const json = await safeJsonFetch(GROUP_LOOKUP_URL);
            if (!json?.isSuccess || !Array.isArray(json?.data)) {
                fillSelect(select, "Select a group (optional)", []);
                setHint("groupHint", json?.message || "Unable to load groups.");
                return;
            }

            const items = json.data
                .map(g => ({id: String(g.id || "").toUpperCase(), name: g.name || g.code || ""}))
                .filter(x => x.id && x.name)
                .sort((a, b) => a.name.localeCompare(b.name));

            fillSelect(select, "Select a group (optional)", items);
        } catch {
            fillSelect(select, "Select a group (optional)", []);
            setHint("groupHint", "Unable to load groups.");
        }
    }

    async function loadJourneyTypes() {
        const select = $("journeyType");
        fillSelect(select, "Loading journey types…", []);
        setHint("journeyHint", "");

        try {
            const json = await safeJsonFetch(JOURNEY_LOOKUP_URL);
            if (!json?.isSuccess || !Array.isArray(json?.data)) {
                fillSelect(select, "Select journey type", []);
                setHint("journeyHint", json?.message || "Unable to load journey types.");
                return;
            }

            const items = json.data
                .filter(j => allowedJourneyCodes.has(String(j.code)))
                .map(j => ({id: String(j.code), name: j.name || ""}))
                .filter(x => x.id && x.name);

            fillSelect(select, "Select journey type", items);
            if (items.some(x => x.id === "1")) select.value = "1";
        } catch {
            fillSelect(select, "Select journey type", []);
            setHint("journeyHint", "Unable to load journey types.");
        }
    }

    async function callPreview(payload) {
        const res = await fetch(PRICING_PREVIEW_URL, {
            method: "POST",
            headers: {
                "accept": "*/*",
                "Content-Type": "application/json",
                "Authorization": getToken()
            },
            body: JSON.stringify(payload)
        });

        const text = await res.text();
        try {
            return JSON.parse(text);
        } catch {
            return {isSuccess: false, statusCode: String(res.status), message: "Non-JSON response"};
        }
    }

    function mapEnum(value, map) {
        if (value === null || value === undefined) return "";
        const n = Number(value);
        return (map[n] !== undefined) ? map[n] : String(value);
    }

    function formatValue(typeLabel, rawValue) {
        if (rawValue === null || rawValue === undefined) return "";
        const n = Number(rawValue);
        const printable = Number.isFinite(n) ? String(n) : String(rawValue);
        return (typeLabel === "Percentage") ? (printable + "%") : printable;
    }

    function setValue(id, v) {
        $(id).textContent = (v === null || v === undefined) ? "" : String(v);
    }

    function onOff(enabled) {
        if (enabled === true) return {variant: "ok", text: "Yes"};
        if (enabled === false) return {variant: "bad", text: "No"};
        return {variant: "", text: ""};
    }

    function normalize(data) {
        if (!data || typeof data !== "object") return null;

        const mkType = mapEnum(data.markupType, typeMap);
        const dsType = mapEnum(data.discountType, typeMap);
        const cmType = mapEnum(data.commissionType, typeMap);

        return {
            supplierName: data.supplierName ?? "",
            supplierCode: data.supplierShortCode ?? "",
            supplierCurrency: data.supplierCurrency ?? "",

            isMarkupApply: data.isMarkupApply,
            markupType: mkType,
            markupValue: formatValue(mkType, data.markupValue),
            markupAppliedOn: mapEnum(data.markupAppliedOn, appliedOnMap),

            isDiscountApply: data.isDiscountApply,
            discountType: dsType,
            discountValue: formatValue(dsType, data.discountValue),
            discountAppliedOn: mapEnum(data.discountAppliedOn, appliedOnMap),

            isCommissionApply: data.isCommissionApply,
            commissionSource: data.commissionSource ?? "",
            commissionAirlineCode: data.commissionAirlineCode,
            commissionType: cmType,
            commissionValue: formatValue(cmType, data.commissionValue),
            commissionAppliedOn: mapEnum(data.commissionAppliedOn, appliedOnMap)
        };
    }

    function toggleAirlineCodeRow(value) {
        const row = $("airlineCodeRow");
        const hasValue = value !== null && value !== undefined && String(value).trim() !== "";
        row.classList.toggle("hiddenRow", !hasValue);
    }

    function renderCards(data) {
        if (!data) {
            showResults(false);
            setPill("resultPill", "", "No data");
            $("commissionSourceInline").textContent = "";
            toggleAirlineCodeRow(null);
            setValue("commissionAirlineCode", "");
            return;
        }

        const d = normalize(data);
        showResults(true);
        setPill("resultPill", "ok", "Loaded");

        setValue("supplierName", d.supplierName);
        setValue("supplierCode", d.supplierCode);
        setValue("supplierCurrency", d.supplierCurrency);
        setPill("supplierPill", "ok", (d.supplierName || d.supplierCode) ? "Ready" : "");

        const mk = onOff(d.isMarkupApply);
        setPill("markupPill", mk.variant, mk.text);
        setValue("markupEnabled", d.isMarkupApply === true ? "Yes" : d.isMarkupApply === false ? "No" : "");
        setValue("markupAppliedOn", d.markupAppliedOn);
        setValue("markupType", d.markupType);
        setValue("markupValue", d.markupValue);

        const ds = onOff(d.isDiscountApply);
        setPill("discountPill", ds.variant, ds.text);
        setValue("discountEnabled", d.isDiscountApply === true ? "Yes" : d.isDiscountApply === false ? "No" : "");
        setValue("discountAppliedOn", d.discountAppliedOn);
        setValue("discountType", d.discountType);
        setValue("discountValue", d.discountValue);

        const cm = onOff(d.isCommissionApply);
        setPill("commissionPill", cm.variant, cm.text);
        setValue("commissionEnabled", d.isCommissionApply === true ? "Yes" : d.isCommissionApply === false ? "No" : "");
        setValue("commissionAppliedOn", d.commissionAppliedOn);
        setValue("commissionType", d.commissionType);
        setValue("commissionValue", d.commissionValue);

        const src = (d.commissionSource && String(d.commissionSource).trim()) ? String(d.commissionSource).trim() : "";
        $("commissionSourceInline").textContent = src ? `(${src})` : "";

        toggleAirlineCodeRow(d.commissionAirlineCode);
        setValue("commissionAirlineCode", d.commissionAirlineCode ?? "");
    }

    function resetDefaultsUiOnly() {
        $("airline").value = "BG";
        $("segOrigin").value = "DAC";
        $("segDestination").value = "CXB";
        $("segDate").value = "2025-12-30";

        $("empty").textContent = "No preview loaded.";
        setPill("resultPill", "", "No data");
        $("commissionSourceInline").textContent = "";
        renderCards(null);
    }

    async function resetAll() {
        resetDefaultsUiOnly();
        await Promise.all([loadPartners(), loadGroups(), loadJourneyTypes()]);
    }

    $("btnReset").addEventListener("click", () => {
        toast("warn", "Reset", "Filters restored to defaults.");
        resetAll();
    });

    $("btnSubmit").addEventListener("click", async () => {
        setSubmitting(true);
        setPill("resultPill", "warn", "Loading…");

        const payload = buildPayload();

        try {
            const response = await callPreview(payload);
            if (response?.isSuccess) {
                renderCards(response.data);
                toast("ok", "Preview loaded", "Pricing preview retrieved successfully.");
            } else {
                renderCards(null);
                setPill("resultPill", "bad", "Failed");
                $("empty").textContent = response?.message || "Request failed.";
                toast("bad", "Request failed", response?.message || "Unable to load preview.");
            }
        } catch (err) {
            renderCards(null);
            setPill("resultPill", "bad", "Error");
            $("empty").textContent = "Error: " + (err?.message || "Unknown");
            toast("bad", "Error", err?.message || "Unknown error.");
        } finally {
            setSubmitting(false);
        }
    });

    resetAll();

</script>

</body>
</html>

