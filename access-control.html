<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>OTA Admin • Access Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
    <div class="topbarInner">

        <div class="brand">
            <div class="mark">
                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2">
                    <path d="M12 22s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11z"/>
                </svg>
            </div>
            <div>
                <div style="font-size:12px;font-weight:1000;">OTA Admin</div>
                <div style="font-size:11px;color:#7c879a;font-weight:900;">Access Control</div>
            </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn" onclick="location.href='pricing-preview.html'">Pricing Preview</button>
            <button class="btn active">Access Control</button>
            <button class="btn" onclick="location.href='login-logs.html'">Login Logs</button>
            <button class="btn" id="btnLogout">Logout</button>
        </div>

    </div>
</div>

<!-- ================= PAGE ================= -->
<div class="shell">

    <!-- ===== GLOBAL MODE ===== -->
    <section class="section">
        <div class="sectionHeader">
            Global Access Mode
            <span class="pill" id="modePill">Loading…</span>
        </div>

        <div class="sectionBody">
            <div id="modeHint"
                 style="font-size:12px;color:#5b677a;font-weight:900;margin-bottom:10px;">
                Loading mode…
            </div>

            <div style="text-align:right;">
                <button class="btn" id="btnSwitchMode">Switch Mode</button>
            </div>
        </div>
    </section>

    <!-- ===== RULES ===== -->
    <section class="section">
        <div class="sectionHeader">
            Rules
            <div style="display:flex;gap:10px;align-items:center;">
                <span class="pill" id="ruleCount">0 Rules</span>
                <button class="btn" id="btnCreateRule">Create Rule</button>
            </div>
        </div>

        <div class="sectionBody">
            <div class="tableBox">
                <table>
                    <thead>
                    <tr>
                        <th>Type</th>
                        <th>Value</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Toggle</th>
                    </tr>
                    </thead>
                    <tbody id="ruleTable"></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<!-- ================= CREATE RULE MODAL ================= -->
<div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
        <div class="modalHeader">Create Access Rule</div>

        <div class="field">
            <label>Rule Type</label>
            <select id="ruleType">
                <option value="IP">IP</option>
                <option value="EMAIL">Email</option>
            </select>
        </div>

        <div class="field">
            <label>Rule Value</label>
            <input id="ruleValue" placeholder="Value"/>
        </div>

        <div class="field">
            <label>Behaviour</label>
            <select id="isAllow">
                <option value="true">Allow</option>
                <option value="false">Block</option>
            </select>
        </div>

        <div class="field">
            <label>Description</label>
            <textarea id="description"></textarea>
        </div>

        <div class="modalActions">
            <button class="btn" id="btnCancel">Cancel</button>
            <button class="btn primary" id="btnSubmitRule">Create</button>
        </div>
    </div>
</div>

<!-- ================= MODE CONFIRM MODAL ================= -->
<div class="modalBackdrop" id="modeConfirmBackdrop">
    <div class="modal">
        <div class="modalHeader">Confirm Global Access Mode Change</div>

        <div class="modalBody" id="modeConfirmMsg"></div>

        <div class="modalActions">
            <button class="btn" id="btnCancelMode">Cancel</button>
            <button class="btn primary" id="btnConfirmMode">Confirm Change</button>
        </div>
    </div>
</div>

<!-- ================= TOAST ================= -->
<div class="toastHost" id="toastHost"></div>

<!-- ================= SCRIPT ================= -->
<script>
    const BASE = "https://akijair.ibos.io/user-management/v1/access-control";

    if (!localStorage.getItem("accessToken")) location.href = "index.html";

    const $ = (id) => document.getElementById(id);
    const token = () => "Bearer " + localStorage.getItem("accessToken");

    btnLogout.onclick = () => {
        localStorage.removeItem("accessToken");
        location.href = "index.html";
    };

    function toast(title, msg){
        const t = document.createElement("div");
        t.className = "toast";
        t.innerHTML = `<strong>${title}</strong><br>${msg}`;
        toastHost.appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }

    /* ===== GLOBAL MODE ===== */
    function setModeHint(mode, allowAll){
        if (mode === "BLACKLIST" && allowAll) {
            modeHint.innerHTML = `
            <strong>Blacklist Mode</strong><br>
            All users are allowed to access the system by default.
            Only users or IPs explicitly blocked by access rules will be denied access.
        `;
        } else {
            modeHint.innerHTML = `
            <strong>Whitelist Mode</strong><br>
            All users are blocked by default.
            Only users or IPs explicitly allowed by access rules will be permitted.
        `;
        }
    }

    async function loadMode(){
        const r = await fetch(BASE + "/mode", { headers:{ Authorization: token() }});
        const j = await r.json();

        if(j?.isSuccess){
            const m = j.data.mode;
            const a = j.data.allowAll === true;
            modePill.className = "pill " + (m === "BLACKLIST" ? "bad" : "ok");
            modePill.textContent = m;
            setModeHint(m, a);
        }
    }

    /* ===== RULES ===== */
    async function loadRules(){
        const r = await fetch(BASE + "/all", { headers:{ Authorization: token() }});
        const j = await r.json();
        if(!j?.isSuccess) return;

        ruleTable.innerHTML = "";
        j.data.forEach(x => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${x.ruleType}</td>
            <td>${x.ruleValue}</td>
            <td>${x.description || ""}</td>
            <td>
                <span class="pill ${x.isAllow ? "ok" : "bad"}">
                    ${x.isAllow ? "ALLOW" : "BLOCK"}
                </span>
            </td>
            <td>
                <button class="btn"
                    onclick="toggleRule('${x.id}',${x.isAllow})">
                    ${x.isAllow ? "Block" : "Allow"}
                </button>
            </td>
        `;
            ruleTable.appendChild(tr);
        });

        ruleCount.textContent = j.data.length + " Rules";
    }

    window.toggleRule = async (id, isAllow) => {
        await fetch(`${BASE}/${id}/${isAllow ? "block" : "allow"}`, {
            method:"PUT",
            headers:{ Authorization: token() }
        });
        loadRules();
        toast("Updated", "Rule updated successfully");
    };

    /* ===== CREATE RULE ===== */
    btnCreateRule.onclick = () => modalBackdrop.style.display = "flex";
    btnCancel.onclick = () => modalBackdrop.style.display = "none";

    btnSubmitRule.onclick = async () => {
        await fetch(BASE, {
            method:"POST",
            headers:{
                Authorization: token(),
                "Content-Type":"application/json"
            },
            body: JSON.stringify({
                ruleType: ruleType.value,
                ruleValue: ruleValue.value.trim(),
                isAllow: isAllow.value === "true",
                description: description.value.trim()
            })
        });

        modalBackdrop.style.display = "none";
        loadRules();
        toast("Created", "Rule added successfully");
    };

    /* ===== MODE SWITCH CONFIRM ===== */
    btnSwitchMode.onclick = () => {
        const current = modePill.textContent.trim();
        const next = current === "BLACKLIST" ? "WHITELIST" : "BLACKLIST";

        if (next === "BLACKLIST") {
            modeConfirmMsg.innerHTML = `
            <strong>Switch to Blacklist Mode</strong><br><br>
            In Blacklist Mode, access is allowed for all users by default.
            Only users, emails, or IP addresses explicitly blocked by rules
            will be denied access.<br><br>
            <strong>Impact:</strong><br>
            • Existing users remain accessible<br>
            • Block rules take effect immediately<br>
            • No user is blocked unless explicitly denied
        `;
        } else {
            modeConfirmMsg.innerHTML = `
            <strong>Switch to Whitelist Mode</strong><br><br>
            In Whitelist Mode, all users are blocked by default.
            Only users, emails, or IP addresses explicitly allowed
            by rules will be able to access the system.<br><br>
            <strong>Impact:</strong><br>
            • All users will be blocked unless allowed<br>
            • Allow rules become mandatory<br>
            • Incorrect setup may lock out administrators
        `;
        }

        modeConfirmBackdrop.style.display = "flex";
    };

    btnCancelMode.onclick = () => {
        modeConfirmBackdrop.style.display = "none";
    };

    btnConfirmMode.onclick = async () => {
        modeConfirmBackdrop.style.display = "none";

        await fetch(BASE + "/mode/switch", {
            method:"PUT",
            headers:{ Authorization: token() }
        });

        loadMode();
        loadRules();
        toast("Mode Changed", "Global access mode updated");
    };

    /* ===== INIT ===== */
    loadMode();
    loadRules();
</script>

</body>
</html>
